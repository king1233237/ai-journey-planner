<!DOCTYPE html>
<html>
<head>
    <title>Routes API v2: Time & Accessibility</title>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; }
        #sidebar { width: 380px; background: #202124; color: white; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.3); z-index: 10; overflow-y: auto; }
        #map { flex: 1; background: #e5e3df; }
        .input-box, select { background: #303134; border: 1px solid #5f6368; color: white; width: 100%; padding: 12px; margin: 8px 0; border-radius: 4px; box-sizing: border-box; }
        label { font-size: 0.85em; color: #9aa0a6; margin-top: 10px; display: block; }
        button { width: 100%; padding: 12px; background: #8ab4f8; color: #202124; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        button:hover { background: #aecbfa; }
        .status-card { background: #303134; padding: 15px; margin-top: 20px; border-radius: 8px; border-left: 4px solid #8ab4f8; display: none; line-height: 1.6; }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin: 10px 0; }
        #custom-time-container { display: none; }
        .arrival-highlight { color: #8ab4f8; font-size: 1.1em; font-weight: bold; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Routes API v2</h2>
        
        <label>Route Settings</label>
        <input id="origin-input" class="input-box" type="text" placeholder="Start Location">
        <input id="dest-input" class="input-box" type="text" placeholder="Destination">
        
        <select id="mode-select" class="input-box">
            <option value="DRIVE">Driving</option>
            <option value="WALK">Walking</option>
            <option value="TRANSIT">Transit</option>
        </select>

        <label>Departure Time</label>
        <select id="time-type" class="input-box" onchange="toggleTimeInput()">
            <option value="NOW">Depart Now</option>
            <option value="CUSTOM">Specific Time</option>
        </select>

        <div id="custom-time-container">
            <input id="departure-time" class="input-box" type="datetime-local">
        </div>

        <div class="toggle-row">
            <span>Wheelchair Optimized</span>
            <input type="checkbox" id="wheelchair-toggle">
        </div>

        <button onclick="runRoutesAPI()">Calculate Route</button>

        <div id="results" class="status-card">
            <div><strong>Distance:</strong> <span id="dist-out">--</span></div>
            <div><strong>Duration:</strong> <span id="time-out">--</span></div>
            <hr style="border: 0; border-top: 1px solid #5f6368; margin: 10px 0;">
            <div>Estimated Arrival:</div>
            <div id="arrival-out" class="arrival-highlight">--:--</div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBkEW1Lf1l5F-cJun39tsGJSL0cZfsZxbk&libraries=places,geometry&callback=initMap" async defer></script>

    <script>
        let map, polyline;
        const API_KEY = 'AIzaSyBkEW1Lf1l5F-cJun39tsGJSL0cZfsZxbk';

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 22.3193, lng: 114.1694 },
                zoom: 12,
                styles: mapStyle,
                disableDefaultUI: true,
                zoomControl: true
            });

            new google.maps.places.Autocomplete(document.getElementById("origin-input"));
            new google.maps.places.Autocomplete(document.getElementById("dest-input"));
            
            // Set default custom time to "now" for the picker
            const now = new Date();
            now.setMinutes(now.getMinutes() + 2); // Add 2 mins buffer so the default isn't "past"
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('departure-time').value = now.toISOString().slice(0, 16);
        }

        /**
        * FUNCTION: toggleTimeInput
        * PURPOSE: UI Logic. Shows or hides the date-time picker 
        * based on whether the user selects "Now" or "Specific Time".
        */
        function toggleTimeInput() {
            const container = document.getElementById('custom-time-container');
            container.style.display = document.getElementById('time-type').value === 'CUSTOM' ? 'block' : 'none';
        }

    /**
     * FUNCTION: runRoutesAPI
     * PURPOSE: The main engine of the app.
     * 1. Collects data from the UI (origin, destination, mode, accessibility).
     * 2. Constructs the JSON "body" for the Routes API v2 request.
     * 3. Sends a POST request to Google's server.
     * 4. Directs the response to the rendering functions.
     */
        async function runRoutesAPI() {
        const origin = document.getElementById("origin-input").value;
        const dest = document.getElementById("dest-input").value;
        const mode = document.getElementById("mode-select").value;
        const isWheelchair = document.getElementById("wheelchair-toggle").checked;

        const body = {
            origin: { address: origin },
            destination: { address: dest },
            travelMode: mode,
            computeAlternativeRoutes: true, // Ask for alternatives if the first has stairs
            routeModifiers: { 
                avoidIndoor: isWheelchair,
                avoidTolls: false,
                avoidHighways: false
            }
        };

        if (mode === 'TRANSIT') {
            body.transitPreferences = {
                // For transit, this is the most effective accessibility toggle
                routingPreference: isWheelchair ? "LESS_WALKING" : "TRANSIT_ROUTING_PREFERENCE_UNSPECIFIED"
            };
        }

        try {
            const response = await fetch("https://routes.googleapis.com/directions/v2:computeRoutes", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Goog-Api-Key': API_KEY,
                    // We add 'legs.steps' to see the actual turn-by-turn data
                    'X-Goog-FieldMask': 'routes.duration,routes.distanceMeters,routes.polyline.encodedPolyline,routes.legs.steps'
                },
                body: JSON.stringify(body)
            });

            const data = await response.json();
            if (data.routes && data.routes.length > 0) {
                const bestRoute = data.routes[0];
                renderRoute(bestRoute, new Date());
                renderInstructions(bestRoute); // New function to check for "Stairs"
            }
        } catch (err) {
            console.error(err);
        }
    }

    /**
     * FUNCTION: renderInstructions
     * PURPOSE: Parses the route steps to display them to the user.
     * CRITICAL LOGIC: Manually scans for words like "stairs" or "steps" 
     * to warn wheelchair users of potential obstacles Google might have missed.
     */
    function renderInstructions(route) {
        const resultsDiv = document.getElementById("results");
        let instructionHtml = "<br><strong>Route Instructions:</strong><ol style='font-size: 0.8em; padding-left: 20px;'>";
        
        let stairsDetected = false;

        route.legs[0].steps.forEach(step => {
            const text = step.navigationInstruction ? step.navigationInstruction.instructions : "Proceed to destination";
            
            // Manual "Stair Detection" - Checking the text for stair keywords
            const warningStyle = text.toLowerCase().includes("stairs") || text.toLowerCase().includes("steps") 
                                ? "color: #ff6b6b; font-weight: bold;" 
                                : "";
            
            if (warningStyle) stairsDetected = true;

            instructionHtml += `<li style="${warningStyle}">${text}</li>`;
        });

        instructionHtml += "</ol>";
        
        if (stairsDetected) {
            instructionHtml = `<div style="color: #ff6b6b; border: 1px solid #ff6b6b; padding: 5px; margin-top: 10px;">⚠️ Warning: Stairs detected on this route!</div>` + instructionHtml;
        }

        resultsDiv.innerHTML += instructionHtml;
    }

    /**
     * FUNCTION: renderRoute
     * PURPOSE: Handles the visual representation on the map.
     * 1. Clears old lines.
     * 2. Decodes the 'Encoded Polyline' string into coordinates.
     * 3. Draws the path and adjusts the map zoom to fit the whole route.
     * 4. Updates the distance and arrival time calculation.
     */    
    function renderRoute(route, depDate) {
            if (polyline) polyline.setMap(null);

            const decodedPath = google.maps.geometry.encoding.decodePath(route.polyline.encodedPolyline);
            polyline = new google.maps.Polyline({
                path: decodedPath,
                strokeColor: "#8ab4f8",
                strokeWeight: 5,
                map: map
            });

            // 1. Calculate and Display Duration
            const durationSecs = parseInt(route.duration);
            const durationMins = Math.floor(durationSecs / 60);
            
            // 2. Calculate Arrival Time
            const arrivalDate = new Date(depDate.getTime() + (durationSecs * 1000));
            const arrivalString = arrivalDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            document.getElementById("results").style.display = "block";
            document.getElementById("dist-out").innerText = (route.distanceMeters / 1000).toFixed(2) + " km";
            document.getElementById("time-out").innerText = durationMins + " mins";
            document.getElementById("arrival-out").innerText = arrivalString;

            const bounds = new google.maps.LatLngBounds();
            decodedPath.forEach(point => bounds.extend(point));
            map.fitBounds(bounds);
        }

        const mapStyle = [
            { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
            { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] }
        ];
    </script>
</body>
</html>